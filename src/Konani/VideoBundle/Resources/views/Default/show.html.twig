{% extends '::base.html.twig' %}

{% block body %}
    <div class="row">
        {% if items|length > 0 %}
            {% for item in items %}
                <div class="col-lg-12"><h1>{{ item.snippet.title }}</h1></div>
                <div class="col-lg-6">
                    <iframe id="ytplayer" type='text/html' src='http://www.youtube.com/embed/{{ item.id }}?rel=0&showinfo=0&autohide=1&iv_load_policy=3&theme=light' width='100%' height="400px" frameborder='0' allowfullscreen></iframe>
                    <p>{{ item.snippet.description }}</p>
                </div>
                <div class="col-lg-6">
                    <div id="map-canvas"></div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-lg-12">
                <div class="alert alert-danger" role="alert">
                    Video not found in youtube. It has been removed or privacy settings was changed.
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        var map;
        var markers = [];

        // Initializes google map
        function initialize() {
            var mapOptions = {
                center: { lat: {{ coordinates.latitude }}, lng: {{ coordinates.longitude}} },
                zoom: 11
            };
            map = new google.maps.Map(document.getElementById('map-canvas'),
                    mapOptions);

            //var markernew = createMarker(new google.maps.LatLng({{ coordinates.latitude }}, {{ coordinates.longitude}}),'');
            //markers.push(markernew);

            google.maps.event.addListener(map, 'idle', function(){
                getVideos(map,this.getBounds(),map.getZoom());
            });

        }

        google.maps.event.addDomListener(window, 'load', initialize);

        // Creates map marker
        function createMarker(point,html)
        {
            var marker=new google.maps.Marker({map:map,position:point,draggable:true,icon:"{{ asset ('img/video_icon_current.png') }}" });
            markers.push(marker);
            return marker;
        }

        function getVideos(map,bounds,zoom){

            deleteOverlays();

            var southWest=bounds.getSouthWest();
            var northEast=bounds.getNorthEast();
            var lngSpan=northEast.lng()-southWest.lng();
            var latSpan=northEast.lat()-southWest.lat();

            var lt1=southWest.lat();
            var lt2=southWest.lat()+latSpan
            var lng1=southWest.lng();
            var lng2=southWest.lng()+lngSpan;

            $.ajax({
                type: "POST",
                url: "{{ path('api_video_list_by_coords') }}",
                data: { min_lat: lt1, max_lat: lt2, min_lng: lng1, max_lng: lng2, zoom: zoom }
            })
            .success(function( data ) {
                $.each(data, function(key, obj) {
                    var icon = '';
                    if (obj.lat == "{{ coordinates.latitude }}" && obj.lng == "{{ coordinates.longitude }}") {
                        icon = "{{ asset('img/video_icon_current.png') }}";
                    } else {
                        icon = "{{ asset('img/video_icon.png') }}";
                    }
                    var myLatLng = new google.maps.LatLng(obj.lat, obj.lng);
                    var beachMarker = new google.maps.Marker({
                        position: myLatLng,
                        map: map,
                        icon: icon,
                        draggable: false
                    });
                    var infowindow = new google.maps.InfoWindow({
                        content: ''
                    });

                    google.maps.event.addListener(beachMarker, 'click', function(e) {
                        $.ajax({
                            type: "POST",
                            url: "{{ path('api_video_one_by_id') }}",
                            data: { id: obj.id }
                        })
                        .success(function( data ) {
                            infowindow.setContent('<h1><a href="/video/show/'+obj.id+'">'+data.title+'</a></h1><img src="'+data.thumbnail+'"/><p>'+data.description+'</p>');
                        });

                        infowindow.open(map,beachMarker);
                    });

                    markers.push(beachMarker);
                });
            });
         }


        // Sets the map on all markers in the array.
        function setAllMap(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the overlays from the map, but keeps them in the array.
        function clearOverlays() {
            setAllMap(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteOverlays() {
            clearOverlays();
            markers = [];
        }

    </script>
{% endblock %}
